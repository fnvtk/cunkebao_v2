# 存客宝开发文档

## 项目概述
存客宝是一个智能客户获取和管理系统，支持多渠道获客、流量池管理、AI分析等功能。

## 技术栈
- **前端框架**: Next.js 14 (App Router)
- **UI组件库**: shadcn/ui + Tailwind CSS
- **状态管理**: React Hooks
- **类型检查**: TypeScript
- **图标库**: Lucide React

## 项目结构

### 核心目录结构
\`\`\`
app/
├── components/           # 全局组件
│   ├── ui/              # UI基础组件
│   ├── common/          # 通用业务组件
│   └── ...
├── scenarios/           # 获客场景模块
│   ├── phone/          # 电话获客
│   ├── poster/         # 海报获客
│   ├── douyin/         # 抖音获客
│   └── ...
├── workspace/          # 工作台模块
│   ├── moments-sync/   # 朋友圈同步
│   ├── group-push/     # 群发推送
│   ├── auto-like/      # 自动点赞
│   └── ...
├── traffic-pool/       # 流量池管理
├── content/           # 内容库管理
├── devices/           # 设备管理
├── wechat-accounts/   # 微信号管理
└── api/              # API路由
\`\`\`

## 组件系统

### 设计原则

1. **统一性**: 所有组件遵循统一的设计规范
2. **可复用性**: 组件设计考虑多场景复用
3. **可扩展性**: 支持自定义样式和行为
4. **性能优化**: 使用虚拟化、懒加载等技术
5. **类型安全**: 完整的TypeScript类型定义

### 组件分类

#### 基础UI组件 (components/ui/)
- Button: 按钮组件
- Card: 卡片容器
- Input: 输入框
- Select: 选择器
- Dialog: 对话框
- Table: 表格
- Progress: 进度条
- Badge: 徽章
- Avatar: 头像
- Tooltip: 工具提示

#### 通用业务组件 (app/components/common/)
- PageHeader: 页面头部，提供标题、描述、操作按钮
- StatCard: 统计卡片，展示关键指标
- DataTable: 数据表格，支持排序、筛选、分页
- DeviceSelector: 设备选择器，支持多选、搜索、过滤
- FileUploader: 文件上传，支持拖拽、多文件、进度显示
- NotificationSystem: 通知系统，支持多种类型的消息提示
- Wizard: 向导组件，用于多步骤流程
- Charts: 图表组件库，包含折线图、柱状图、饼图等
- VirtualizedList: 虚拟化列表，高性能渲染大量数据
- LazyLoad: 懒加载组件，优化页面加载性能

### 组件使用规范

#### 导入方式
\`\`\`typescript
// 基础UI组件
import { Button, Card, Input } from "@/components/ui"

// 通用业务组件
import { PageHeader, StatCard, DataTable } from "@/app/components/common"
\`\`\`

#### 命名规范
- 组件文件使用PascalCase命名
- 组件导出使用具名导出
- Props接口以组件名 + Props命名

#### 样式规范
- 使用Tailwind CSS类名
- 支持className prop进行样式扩展
- 使用cn()函数合并类名

## 功能模块

### 1. 场景获客 (/scenarios)
- 多渠道获客计划创建和管理
- 支持手机号、海报、抖音等获客方式
- 设备选择和配置
- 获客数据统计和分析

### 2. 工作台 (/workspace)
- 朋友圈同步
- 群发消息
- 自动点赞
- 自动建群
- 群同步
- 流量分发
- AI助手
- AI分析
- AI策略

### 3. 设备管理 (/devices)
- 设备列表展示
- 设备状态监控
- 设备配置管理
- 设备分组和标签管理
- 设备性能分析

### 4. 内容库 (/content)
- 内容素材管理
- 内容分类和标签
- 内容预览和编辑
- 批量导入和导出

### 5. 流量池 (/traffic-pool)
- 流量池创建和管理
- 流量分配策略
- 流量使用统计
- 流量质量分析

### 6. 微信号管理 (/wechat-accounts)
- 微信号绑定和管理
- 账号状态监控
- 好友和群组管理
- 消息记录查看

## 最新更新 - 流量池功能优化

### 更新时间
2024年12月19日

### 更新内容

#### 1. 流量池页面重构
- **文件**: `app/traffic-pool/page.tsx`
- **优化内容**:
  - 修复了React无限循环错误
  - 整合了流量池列表与数据分析界面
  - 使用可折叠组件优化页面布局
  - 支持多设备选择功能
  - 优化了用户体验和界面响应性

#### 2. 新增流量池管理组件
- **文件**: `app/traffic-pool/components/pool-management.tsx`
- **功能**:
  - 流量池的创建、编辑、删除
  - 流量池状态和优先级管理
  - 标签系统支持
  - 用户数量统计
  - 完整的CRUD操作界面

#### 3. 多设备选择器组件
- **文件**: `app/traffic-pool/components/multi-device-selector.tsx`
- **功能**:
  - 支持多设备批量选择
  - 设备状态实时显示（在线/离线/忙碌）
  - 设备信息详细展示（电量、位置、微信号数量等）
  - 搜索和筛选功能
  - 设备使用情况统计

#### 4. 数据分析仪表板
- **文件**: `app/traffic-pool/components/analytics-dashboard.tsx`
- **功能**:
  - 用户价值分布可视化
  - 添加效率分析
  - 数据质量指标
  - 增长趋势分析
  - 核心KPI展示

### 技术改进

#### 1. 性能优化
- 使用 `useCallback` 和 `useMemo` 优化组件渲染
- 避免在渲染过程中的状态更新
- 优化事件处理函数，防止无限循环

#### 2. 用户体验优化
- 响应式设计，支持移动端和桌面端
- 可折叠的侧边栏，节省屏幕空间
- 实时搜索和筛选功能
- 批量操作支持

#### 3. 代码结构优化
- 组件模块化，提高可复用性
- 类型安全，完整的TypeScript支持
- 统一的错误处理和用户反馈

### 核���功能

#### 流量池管理
1. **流量池CRUD操作**
   - 创建新流量池
   - 编辑流量池信息
   - 删除空流量池
   - 流量池状态管理

2. **用户分配管理**
   - 批量添加用户到流量池
   - 用户价值评估（RFM模型）
   - 重复用户检测
   - 用户标签管理

3. **数据分析**
   - 用户价值分布
   - 添加效率统计
   - 转化率分析
   - 增长趋势监控

#### 设备管理
1. **多设备支持**
   - 设备状态监控
   - 批量设备选择
   - 设备性能统计
   - 设备使用情况分析

2. **微信号管理**
   - 微信号状态监控
   - 添加限制管理
   - 好友数量统计
   - 账号安全状态

### 数据模型

#### 流量池用户模型
\`\`\`typescript
interface TrafficUser {
  id: string
  avatar: string
  nickname: string
  wechatId: string
  phone: string
  region: string
  note: string
  status: "pending" | "added" | "failed" | "duplicate"
  addTime: string
  source: string
  scenario: string
  deviceId: string
  wechatAccountId: string
  customerServiceId: string
  poolIds: string[]
  tags: UserTag[]
  rfmScore: RFMScore
  lastInteraction: string
  totalSpent: number
  interactionCount: number
  conversionRate: number
  isDuplicate: boolean
  mergedAccounts: string[]
  addStatus: "not_added" | "adding" | "added" | "failed"
  interactions: UserInteraction[]
}
\`\`\`

#### RFM评分模型
\`\`\`typescript
interface RFMScore {
  recency: number    // 最近性评分 (1-5)
  frequency: number  // 频率评分 (1-5)
  monetary: number   // 金额评分 (1-5)
  total: number      // 总分 (3-15)
  segment: string    // 用户分群
  priority: "high" | "medium" | "low"  // 优先级
}
\`\`\`

### API设计

#### 流量池相关API
- `GET /api/traffic-pool` - 获取流量池列表
- `POST /api/traffic-pool` - 创建流量池
- `PUT /api/traffic-pool/:id` - 更新流量池
- `DELETE /api/traffic-pool/:id` - 删除流量池
- `POST /api/traffic-pool/:id/users` - 添加用户到流量池
- `DELETE /api/traffic-pool/:id/users` - 从流量池移除用户

#### 用户管理API
- `GET /api/traffic-pool/users` - 获取流量池用户列表
- `GET /api/traffic-pool/users/:id` - 获取用户详情
- `PUT /api/traffic-pool/users/:id` - 更新用户信息
- `POST /api/traffic-pool/users/batch` - 批量操作用户

### 部署说明

#### 环境要求
- Node.js 18+
- npm 或 yarn
- 支持的浏览器：Chrome 90+, Firefox 88+, Safari 14+

#### 构建命令
\`\`\`bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产构建
npm run build

# 启动生产服务
npm start
\`\`\`

### 注意事项

1. **性能考虑**
   - 大量用户数据时使用虚拟滚动
   - 合理使用分页，避免一次性加载过多数据
   - 图片懒加载优化

2. **安全考虑**
   - 用户数据脱敏处理
   - API访问权限控制
   - 敏感操作二次确认

3. **用户体验**
   - 操作反馈及时
   - 错误信息友好
   - 加载状态明确

### 后续规划

1. **功能扩展**
   - AI智能推荐流量池分配
   - 用户行为预测分析
   - 自动化营销流程

2. **性能优化**
   - 数据缓存策略
   - 实时数据同步
   - 离线功能支持

3. **集成扩展**
   - 第三方CRM系统集成
   - 营销自动化平台对接
   - 数据导入导出功能

---

## 开发规范

### 代码规范
1. 使用TypeScript进行类型检查
2. 组件命名使用PascalCase
3. 文件命名使用kebab-case
4. 每个功能模块都要有中文注释
5. 使用统一的错误处理机制

### 组件设计原则
1. 单一职责原则
2. 可复用性优先
3. 响应式设计
4. 无障碍访问支持
5. 性能优化考虑

### Git提交规范
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建过程或辅助工具的变动

### 代码规范

#### TypeScript规范
\`\`\`typescript
// 接口定义
interface DeviceProps {
  id: string
  name: string
  status: 'online' | 'offline' | 'busy'
  type: DeviceType
  onEdit?: (id: string) => void
}

// 组件定义
export function DeviceCard({ id, name, status, type, onEdit }: DeviceProps) {
  // 组件实现
}
\`\`\`

#### React Hooks规范
\`\`\`typescript
// 自定义Hook
export function useDeviceStatus(deviceId: string) {
  const [status, setStatus] = useState<DeviceStatus>('offline')
  
  useEffect(() => {
    // 状态监听逻辑
  }, [deviceId])
  
  return { status, setStatus }
}
\`\`\`

#### 样式规范
\`\`\`typescript
// 使用cn函数合并类名
const cardClasses = cn(
  "p-4 border rounded-lg",
  isSelected && "border-blue-500 bg-blue-50",
  disabled && "opacity-50 cursor-not-allowed",
  className
)
\`\`\`

### 性能优化

#### 组件优化
\`\`\`typescript
// 使用memo优化组件渲染
const DeviceCard = memo(({ device, onEdit }: DeviceCardProps) => {
  const handleEdit = useCallback(() => {
    onEdit(device.id)
  }, [device.id, onEdit])
  
  return (
    <Card onClick={handleEdit}>
      {/* 组件内容 */}
    </Card>
  )
})
\`\`\`

#### 列表优化
\`\`\`typescript
// 使用虚拟化列表处理大数据
<VirtualizedList
  items={devices}
  itemHeight={80}
  height={400}
  renderItem={(device, index) => (
    <DeviceCard key={device.id} device={device} />
  )}
/>
\`\`\`

#### 懒加载优化
\`\`\`typescript
// 使用懒加载优化页面性能
<LazyLoad placeholder={<DeviceCardSkeleton />}>
  <DeviceCard device={device} />
</LazyLoad>
\`\`\`

## API设计

### RESTful API规范

#### 设备管理API
\`\`\`typescript
// 获取设备列表
GET /api/devices?page=1&limit=20&status=online

// 获取单个设备
GET /api/devices/:id

// 创建设备
POST /api/devices
{
  "name": "设备001",
  "type": "android",
  "imei": "123456789"
}

// 更新设备
PUT /api/devices/:id
{
  "name": "新设备名称",
  "status": "online"
}

// 删除设备
DELETE /api/devices/:id
\`\`\`

#### 场景获客API
\`\`\`typescript
// 获取场景列表
GET /api/scenarios?channel=phone&status=active

// 创建场景
POST /api/scenarios
{
  "name": "手机号获客计划",
  "channel": "phone",
  "settings": {
    "targetCount": 1000,
    "dailyLimit": 100
  }
}
\`\`\`

### 数据库设计

#### 设备表 (devices)
\`\`\`sql
CREATE TABLE devices (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  imei VARCHAR(50) UNIQUE,
  type ENUM('android', 'ios', 'windows'),
  status ENUM('online', 'offline', 'busy'),
  battery_level INT,
  friend_count INT,
  last_active_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
\`\`\`

#### 场景表 (scenarios)
\`\`\`sql
CREATE TABLE scenarios (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  channel ENUM('phone', 'poster', 'douyin', 'api'),
  status ENUM('active', 'paused', 'completed'),
  settings JSON,
  target_count INT,
  acquired_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
\`\`\`

## 部署和运维

### 环境配置

#### 开发环境
\`\`\`bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 类型检查
npm run type-check

# 代码格式化
npm run format
\`\`\`

#### 生产环境
\`\`\`bash
# 构建项目
npm run build

# 启动生产服务器
npm start

# 运行测试
npm test
\`\`\`

### 监控和日志

#### 性能监控
- 页面加载时间监控
- API响应时间监控
- 组件渲染性能监控
- 内存使用情况监控

#### 错误日志
- 前端错误捕获和上报
- API错误日志记录
- 用户行为日志追踪
- 系统异常告警

## 最新更新 - 付款码获客功能（2024-01-26）

### 功能概述
付款码获客通过生成专属收款二维码，用户扫码付款后自动进入私域客户池。支持分销奖励、红包、自动化任务等功能。

### 已完成功能（40%）
1. **付款码管理主页** (`/scenarios/payment`)
   - 四个标签页：付款码列表、数据统计、分销返利、红包池
   - 支持查看付款码状态和基础数据

2. **新建付款码** (`/scenarios/payment/new`)
   - 基本信息设置：名称、支付方式、金额、描述
   - 高级设置：分销返利、红包奖励、自动欢迎语
   - 客户标签自动设置

3. **付款码详情** (`/scenarios/payment/[id]`)
   - 展示付款码二维码
   - 支付记录列表
   - 高级设置管理
   - 支持下载、分享、复制功能

4. **支付记录列表** (`/scenarios/payment/[id]/payments`)
   - 支持搜索和筛选
   - 展示详细支付信息
   - 支持导出功能
   - 分页展示

5. **数据统计** (`/scenarios/payment/stats`)
   - 多维度数据展示
   - 趋势图表分析
   - 支付方式分布
   - 地域分布统计

### 待开发功能（60%）
1. **分销返利管理**
   - 分销规则设置
   - 返利记录查询
   - 返利统计报表

2. **红包池管理**
   - 红包规则设置
   - 发放记录查询
   - 红包统计报表

3. **API集成**
   - 付款码生成接口对接
   - 支付回调处理
   - 数据同步机制

4. **实时功能**
   - 支付通知推送
   - 数据实时更新
   - 状态同步

5. **批量操作**
   - 批量生成付款码
   - 批量导出数据
   - 批量设置规则

### API接口规范
\`\`\`typescript
// 生成付款码
POST /api/v1/lead-generation/payment-codes
{
  paymentMethod: string,
  amount?: number,
  description: string,
  metadata?: object
}

// 获取付款码列表
GET /api/v1/lead-generation/payment-codes

// 获取付款码详情
GET /api/v1/lead-generation/payment-codes/{id}

// 获取支付记录
GET /api/v1/lead-generation/payment-records
\`\`\`

### 组件规范
1. 所有页面支持移动端适配
2. 使用骨架屏提升加载体验
3. 统一使用 toast 进行消息提示
4. 表单验证使用统一的错误提示样式

### 注意事项
1. 付款码二维码使用 qrcode.react 生成
2. 支付金额支持固定和自由两种模式
3. 所有金额计算保留两位小数
4. 时间显示使用本地化格式

## 更新记录

### v1.3.0 (2024-01-20)
- 新增组件展示页面和文档系统
- 实现虚拟化列表和懒加载组件
- 优化设备管理页面性能
- 完善组件库文档

### v1.2.0 (2024-01-15)
- 新增文件上传组件
- 新增向导组件
- 新增通知系统
- 新增图表组件库

### v1.1.0 (2024-01-10)
- 优化设备选择器组件
- 改进数据表格响应式设计
- 统一组件样式规范

### v1.0.0 (2024-01-01)
- 项目初始化
- 基础组件库搭建
- 核心功能模块实现

## 贡献指南

### 开发流程
1. 从main分支创建功能分支
2. 开发新功能或修复bug
3. 编写单元测试
4. 提交代码并创建Pull Request
5. 代码审查通过后合并

### 代码提交规范
\`\`\`
feat: 新增功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建工具或辅助工具的变动
\`\`\`

### 组件开发规范
1. 组件必须包含TypeScript类型定义
2. 组件必须支持className属性
3. 组件必须包含使用示例
4. 复杂组件需要编写单元测试
5. 组件需要添加到组件展示页面

## 常见问题

### Q: 如何添加新的UI组件？
A: 在`components/ui/`目录下创建新组件，参考现有组件的结构和规范。

### Q: 如何优化大列表的性能？
A: 使用`VirtualizedList`组件处理大量数据的渲染。

### Q: 如何实现组件的懒加载？
A: 使用`LazyLoad`组件包装需要懒加载的内容。

### Q: 如何自定义组件样式？
A: 通过`className`属性传入自定义样式，使用`cn()`函数合并类名。

### Q: 如何处理组件的状态管理？
A: 优先使用React Hooks，复杂状态可以考虑Context或状态管理库.
